<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <link rel="stylesheet" type="text/css" href="../../../../codoc.css"/>
    <title>Weak_hashtbl</title>
  </head>
  <body>

  <div class="module codoc-doc">
      <a href="../../../">Up</a>
      <div class="intro"><h1 class="title"><span class="keyword">module</span> <a href="">Weak_hashtbl</a></h1> : <span class="keyword">sig</span></div>
      
      <div class="doc">
        
      <p>A hashtable that keeps a weak pointer to each key's data and uses a finalizer to
detect when the data is no longer referenced (by any non-weak pointers).</p>
      
      <p>Once a key's data is finalized, the table will effectively behave as if the key is not
in the table, e.g. <code>find</code> will return <code>None</code>. However, one must call
<code>reclaim_space_for_keys_with_unused_data</code> to actually reclaim the space used by the
table for such keys.</p>
      
      <p>Unlike (OCaml's) <code>Weak.Make</code>, which also describes itself as a &quot;weak hashtable,&quot;
<code>Weak_hashtbl</code> gives a dictionary style structure. In fact, OCaml's <code>Weak.Make</code> may
better be described as a weak set.</p>
      
      <p>There's a tricky type of bug one can write with this module, e.g.:</p>
      <pre><code>      type t =
        { foo : string
        ; bar : float Incr.t
        }

      let tbl = Weak_hashtbl.create ()
      let x1 =
        let t = Weak_hashtbl.find_or_add tbl key ~default:(fun () -&gt;
          (... some function that computes a t...))
        in
        t.bar</code></pre>
      <p>At this point, the data associated with <code>key</code> is unreachable (since all we did with it
was project out field bar), so it may disappear from the table at any time.</p>
      
        
      </div>
    
      
    <div class="sig">
  <div class="region" id="/type:t">
  <a href="index.html#/type:t" class="anchor">#</a>
  
  <div class="type">
    <span class="keyword">type</span> ('a, 'b) t
    
  </div>
  
  </div>
  
  <div class="region" id="/val:create">
  <a href="index.html#/val:create" class="anchor">#</a>
  
  <div class="val">
    <span class="keyword">val</span> create : 'a <a href="../../../../typerep.112.06.00/_build/lib/std_internal/">Std_internal</a>.Hashtbl.Hashable.t <span class="rarr"><span>-&gt;</span></span> ('a, 'b) <a href="index.html#/type:t">t</a>
    
  </div>
  
  </div>
  
  <div class="region" id="/val:mem">
  <a href="index.html#/val:mem" class="anchor">#</a>
  
  <div class="val">
    <span class="keyword">val</span> mem : ('a, _) <a href="index.html#/type:t">t</a> <span class="rarr"><span>-&gt;</span></span> 'a <span class="rarr"><span>-&gt;</span></span> bool
    
  </div>
  
  </div>
  
  <div class="region" id="/val:find">
  <a href="index.html#/val:find" class="anchor">#</a>
  
  <div class="val">
    <span class="keyword">val</span> find : ('a, 'b) <a href="index.html#/type:t">t</a> <span class="rarr"><span>-&gt;</span></span> 'a <span class="rarr"><span>-&gt;</span></span> 'b <a href="../../../../core_kernel.112.06.02/_build/lib/heap_block/">Heap_block</a>.<a href="../../../../core_kernel.112.06.02/_build/lib/heap_block/#/type:t">t</a> option
    
  </div>
  
  </div>
  
  <div class="region" id="/val:find_or_add">
  <a href="index.html#/val:find_or_add" class="anchor">#</a>
  
  <div class="val">
    <span class="keyword">val</span> find_or_add : ('a, 'b) <a href="index.html#/type:t">t</a> <span class="rarr"><span>-&gt;</span></span> 'a <span class="rarr"><span>-&gt;</span></span> default:(unit <span class="rarr"><span>-&gt;</span></span> 'b <a href="../../../../core_kernel.112.06.02/_build/lib/heap_block/">Heap_block</a>.<a href="../../../../core_kernel.112.06.02/_build/lib/heap_block/#/type:t">t</a>) <span class="rarr"><span>-&gt;</span></span> 'b <a href="../../../../core_kernel.112.06.02/_build/lib/heap_block/">Heap_block</a>.<a href="../../../../core_kernel.112.06.02/_build/lib/heap_block/#/type:t">t</a>
    
  </div>
  
  </div>
  
  <div class="region" id="/val:remove">
  <a href="index.html#/val:remove" class="anchor">#</a>
  
  <div class="val">
    <span class="keyword">val</span> remove : ('a, 'b) <a href="index.html#/type:t">t</a> <span class="rarr"><span>-&gt;</span></span> 'a <span class="rarr"><span>-&gt;</span></span> unit
    
  </div>
  
  </div>
  
  <div class="region" id="/val:add_exn">
  <a href="index.html#/val:add_exn" class="anchor">#</a>
  
  <div class="val">
    <span class="keyword">val</span> add_exn : ('a, 'b) <a href="index.html#/type:t">t</a> <span class="rarr"><span>-&gt;</span></span> key:'a <span class="rarr"><span>-&gt;</span></span> data:'b <a href="../../../../core_kernel.112.06.02/_build/lib/heap_block/">Heap_block</a>.<a href="../../../../core_kernel.112.06.02/_build/lib/heap_block/#/type:t">t</a> <span class="rarr"><span>-&gt;</span></span> unit
    
  </div>
  
  </div>
  
  <div class="region" id="/val:replace">
  <a href="index.html#/val:replace" class="anchor">#</a>
  
  <div class="val">
    <span class="keyword">val</span> replace : ('a, 'b) <a href="index.html#/type:t">t</a> <span class="rarr"><span>-&gt;</span></span> key:'a <span class="rarr"><span>-&gt;</span></span> data:'b <a href="../../../../core_kernel.112.06.02/_build/lib/heap_block/">Heap_block</a>.<a href="../../../../core_kernel.112.06.02/_build/lib/heap_block/#/type:t">t</a> <span class="rarr"><span>-&gt;</span></span> unit
    
  </div>
  
  </div>
  
  <div class="region" id="/val:key_is_using_space">
  <a href="index.html#/val:key_is_using_space" class="anchor">#</a>
  
  <div class="val">
    <span class="keyword">val</span> key_is_using_space : ('a, _) <a href="index.html#/type:t">t</a> <span class="rarr"><span>-&gt;</span></span> 'a <span class="rarr"><span>-&gt;</span></span> bool
    
      <div class="doc">
        
      <p><code>key_is_using_space t key</code> returns <code>true</code> if <code>key</code> is using some space in <code>t</code>. <code>mem t
    key</code> implies <code>key_is_using_space t key</code>, but it is also possible that that
<code>key_is_using_space t key &amp;&amp; not (mem t key)</code>.</p>
      
        
      </div>
    
  </div>
  
  </div>
  
  <div class="region" id="/val:reclaim_space_for_keys_with_unused_data">
  <a href="index.html#/val:reclaim_space_for_keys_with_unused_data" class="anchor">#</a>
  
  <div class="val">
    <span class="keyword">val</span> reclaim_space_for_keys_with_unused_data : (_, _) <a href="index.html#/type:t">t</a> <span class="rarr"><span>-&gt;</span></span> unit
    
      <div class="doc">
        
      <p><code>reclaim_space_for_keys_with_unused_data t</code> reclaims space for all keys in <code>t</code> whose
data has been detected (by a finalizer) to be unused. Only <code>key</code>s such that
<code>key_is_using_space t key &amp;&amp; not (mem t key)</code> will be reclaimed.</p>
      
        
      </div>
    
  </div>
  
  </div>
  
  <div class="region" id="/val:set_run_when_unused_data">
  <a href="index.html#/val:set_run_when_unused_data" class="anchor">#</a>
  
  <div class="val">
    <span class="keyword">val</span> set_run_when_unused_data : (_, _) <a href="index.html#/type:t">t</a> <span class="rarr"><span>-&gt;</span></span> thread_safe_f:(unit <span class="rarr"><span>-&gt;</span></span> unit) <span class="rarr"><span>-&gt;</span></span> unit
    
      <div class="doc">
        
      <p><code>set_run_when_unused_data t ~thread_safe_f</code> calls <code>thread_safe_f</code> in the finalizer
attached to each <code>data</code> in <code>t</code>, after ensuring the entry being finalized will be
handled in the next call to <code>reclaim_space_for_keys_with_unused_data</code>. This can be
used to arrange to call <code>reclaim_space_for_keys_with_unused_data</code> at a convenient time
in the future. <code>thread_safe_f</code> must be thread safe -- it is *not* safe for it to call
any <code>Weak_hashtbl</code> functions.</p>
      
        
      </div>
    
  </div>
  
  </div>
  
  <div class="region" id="/val:sexp_of_t">
  <a href="index.html#/val:sexp_of_t" class="anchor">#</a>
  
  <div class="val">
    <span class="keyword">val</span> sexp_of_t : ('a <span class="rarr"><span>-&gt;</span></span> Sexplib.Sexp.t) <span class="rarr"><span>-&gt;</span></span> ('b <span class="rarr"><span>-&gt;</span></span> Sexplib.Sexp.t) <span class="rarr"><span>-&gt;</span></span> ('a, 'b) <a href="index.html#/type:t">t</a> <span class="rarr"><span>-&gt;</span></span> Sexplib.Sexp.t
    
  </div>
  
  </div>
  </div>
    <div class="outro"><span class="keyword">end</span></div>
    
  </div>
  
  </body>
</html>