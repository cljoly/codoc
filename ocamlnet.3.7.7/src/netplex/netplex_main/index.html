<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <link rel="stylesheet" type="text/css" href="../../../../codoc.css"/>
    <title>Netplex_main</title>
  </head>
  <body>

  <div class="module codoc-doc">
      <a href="../../../">Up</a>
      <div class="intro"><h1 class="title"><span class="keyword">module</span> <a href="">Netplex_main</a></h1> : <span class="keyword">sig</span></div>
      
      <div class="doc">
        
      <p>Main program for Netplex servers</p>
      
        
      </div>
    
      
    <div class="sig">
  <div class="region" id="/type:cmdline_config">
  <a href="index.html#/type:cmdline_config" class="anchor">#</a>
  
  <div class="type">
    <span class="keyword">type</span> cmdline_config
    
  </div>
  
  </div>
  
  <div class="region" id="/val:args">
  <a href="index.html#/val:args" class="anchor">#</a>
  
  <div class="val">
    <span class="keyword">val</span> args : ?defaults:<a href="index.html#/type:cmdline_config">cmdline_config</a> <span class="rarr"><span>-&gt;</span></span> unit <span class="rarr"><span>-&gt;</span></span> (<a href="../../../../ocaml.4.02.1+doc/stdlib/arg/">Arg</a>.<a href="../../../../ocaml.4.02.1+doc/stdlib/arg/#/type:key">key</a> * <a href="../../../../ocaml.4.02.1+doc/stdlib/arg/">Arg</a>.<a href="../../../../ocaml.4.02.1+doc/stdlib/arg/#/type:spec">spec</a> * <a href="../../../../ocaml.4.02.1+doc/stdlib/arg/">Arg</a>.<a href="../../../../ocaml.4.02.1+doc/stdlib/arg/#/type:doc">doc</a>) list * <a href="index.html#/type:cmdline_config">cmdline_config</a>
    
      <div class="doc">
        
      <p><code>let (opt_list, cmdline_cfg) = args()</code>:
Returns <code>opt_list</code> for inclusion in the <code>Arg.parse</code> option list.
The effects made available by the returned <code>cmdline_cfg</code> value.</p>
      
      <p>The defaults (unless overridden by <code>defaults</code>): The config file
is derived from the name of the executable (by appending <code>.conf</code>
instead of the current extension). There is no config tree.</p>
      
        
  <div class="tag param">
    <span class="label">defaults</span> The default argument values
  </div>
  
      </div>
    
  </div>
  
  </div>
  
  <div class="region" id="/val:create">
  <a href="index.html#/val:create" class="anchor">#</a>
  
  <div class="val">
    <span class="keyword">val</span> create : ?config_filename:string <span class="rarr"><span>-&gt;</span></span> ?config_tree:<a href="../../../../ocamlnet.3.7.7/src/netplex/netplex_types/">Netplex_types</a>.<a href="../../../../ocamlnet.3.7.7/src/netplex/netplex_types/#/type:config_tree">config_tree</a> <span class="rarr"><span>-&gt;</span></span> ?pidfile:string option <span class="rarr"><span>-&gt;</span></span> ?foreground:bool <span class="rarr"><span>-&gt;</span></span> unit <span class="rarr"><span>-&gt;</span></span> <a href="index.html#/type:cmdline_config">cmdline_config</a>
    
      <div class="doc">
        
      <p>Creates the command-line configuration object.</p>
      
      <p>By setting <code>config_tree</code> a special configuration can be injected -
the file <code>config_filename</code> is not loaded in this case (but may
still appear in error messages)</p>
      
        
      </div>
    
  </div>
  
  </div>
  
  <div class="region" id="/val:modify">
  <a href="index.html#/val:modify" class="anchor">#</a>
  
  <div class="val">
    <span class="keyword">val</span> modify : ?config_filename:string <span class="rarr"><span>-&gt;</span></span> ?config_tree:<a href="../../../../ocamlnet.3.7.7/src/netplex/netplex_types/">Netplex_types</a>.<a href="../../../../ocamlnet.3.7.7/src/netplex/netplex_types/#/type:config_tree">config_tree</a> <span class="rarr"><span>-&gt;</span></span> ?pidfile:string option <span class="rarr"><span>-&gt;</span></span> ?foreground:bool <span class="rarr"><span>-&gt;</span></span> <a href="index.html#/type:cmdline_config">cmdline_config</a> <span class="rarr"><span>-&gt;</span></span> <a href="index.html#/type:cmdline_config">cmdline_config</a>
    
      <div class="doc">
        
      <p>Modifies the command-line configuration object</p>
      
        
      </div>
    
  </div>
  
  </div>
  
  <div class="region" id="/val:config_filename">
  <a href="index.html#/val:config_filename" class="anchor">#</a>
  
  <div class="val">
    <span class="keyword">val</span> config_filename : <a href="index.html#/type:cmdline_config">cmdline_config</a> <span class="rarr"><span>-&gt;</span></span> string
    
      <div class="doc">
        
      <p>Returns the filename of the configuration file, or the default
if it has not been set on the command-line</p>
      
        
      </div>
    
  </div>
  
  </div>
  
  <div class="region" id="/val:config_filename_opt">
  <a href="index.html#/val:config_filename_opt" class="anchor">#</a>
  
  <div class="val">
    <span class="keyword">val</span> config_filename_opt : <a href="index.html#/type:cmdline_config">cmdline_config</a> <span class="rarr"><span>-&gt;</span></span> string option
    
      <div class="doc">
        
      <p>Returns the filename of the configuration file, or <code>None</code> if it
has not been set on the command-line</p>
      
        
      </div>
    
  </div>
  
  </div>
  
  <div class="region" id="/val:config_tree_opt">
  <a href="index.html#/val:config_tree_opt" class="anchor">#</a>
  
  <div class="val">
    <span class="keyword">val</span> config_tree_opt : <a href="index.html#/type:cmdline_config">cmdline_config</a> <span class="rarr"><span>-&gt;</span></span> <a href="../../../../ocamlnet.3.7.7/src/netplex/netplex_types/">Netplex_types</a>.<a href="../../../../ocamlnet.3.7.7/src/netplex/netplex_types/#/type:config_tree">config_tree</a> option
    
      <div class="doc">
        
      <p>Returns the tree of the configuration file, or <code>None</code> if it
has not been set by <code>create</code> or <code>modify</code>. Note that <code>args</code>
never sets the config tree.</p>
      
        
      </div>
    
  </div>
  
  </div>
  
  <div class="region" id="/val:pidfile">
  <a href="index.html#/val:pidfile" class="anchor">#</a>
  
  <div class="val">
    <span class="keyword">val</span> pidfile : <a href="index.html#/type:cmdline_config">cmdline_config</a> <span class="rarr"><span>-&gt;</span></span> string option
    
      <div class="doc">
        
      <p>Returns the location of the PID file (if any)</p>
      
        
      </div>
    
  </div>
  
  </div>
  
  <div class="region" id="/val:foreground">
  <a href="index.html#/val:foreground" class="anchor">#</a>
  
  <div class="val">
    <span class="keyword">val</span> foreground : <a href="index.html#/type:cmdline_config">cmdline_config</a> <span class="rarr"><span>-&gt;</span></span> bool
    
      <div class="doc">
        
      <p>Returns whether the daemon runs in the foreground</p>
      
        
      </div>
    
  </div>
  
  </div>
  
  <div class="region" id="/val:startup">
  <a href="index.html#/val:startup" class="anchor">#</a>
  
  <div class="val">
    <span class="keyword">val</span> startup : ?late_initializer:(<a href="../../../../ocamlnet.3.7.7/src/netplex/netplex_types/">Netplex_types</a>.<a href="../../../../ocamlnet.3.7.7/src/netplex/netplex_types/#/classtype:config_file">config_file</a> <span class="rarr"><span>-&gt;</span></span> <a href="../../../../ocamlnet.3.7.7/src/netplex/netplex_types/">Netplex_types</a>.<a href="../../../../ocamlnet.3.7.7/src/netplex/netplex_types/#/classtype:controller">controller</a> <span class="rarr"><span>-&gt;</span></span> unit) <span class="rarr"><span>-&gt;</span></span> ?config_parser:(string <span class="rarr"><span>-&gt;</span></span> <a href="../../../../ocamlnet.3.7.7/src/netplex/netplex_types/">Netplex_types</a>.<a href="../../../../ocamlnet.3.7.7/src/netplex/netplex_types/#/classtype:config_file">config_file</a>) <span class="rarr"><span>-&gt;</span></span> <a href="../../../../ocamlnet.3.7.7/src/netplex/netplex_types/">Netplex_types</a>.<a href="../../../../ocamlnet.3.7.7/src/netplex/netplex_types/#/classtype:parallelizer">parallelizer</a> <span class="rarr"><span>-&gt;</span></span> <a href="../../../../ocamlnet.3.7.7/src/netplex/netplex_types/">Netplex_types</a>.<a href="../../../../ocamlnet.3.7.7/src/netplex/netplex_types/#/classtype:logger_factory">logger_factory</a> list <span class="rarr"><span>-&gt;</span></span> <a href="../../../../ocamlnet.3.7.7/src/netplex/netplex_types/">Netplex_types</a>.<a href="../../../../ocamlnet.3.7.7/src/netplex/netplex_types/#/classtype:workload_manager_factory">workload_manager_factory</a> list <span class="rarr"><span>-&gt;</span></span> <a href="../../../../ocamlnet.3.7.7/src/netplex/netplex_types/">Netplex_types</a>.<a href="../../../../ocamlnet.3.7.7/src/netplex/netplex_types/#/classtype:processor_factory">processor_factory</a> list <span class="rarr"><span>-&gt;</span></span> <a href="index.html#/type:cmdline_config">cmdline_config</a> <span class="rarr"><span>-&gt;</span></span> unit
    
      <div class="doc">
        
      <p>Establishes a configuration and starts the Netplex daemon.</p>
      
      <p>If a ready-made configuration tree is included in the passed configuration
it is taken as the configuration. If otherwise only the name of the
config file is available, this file is parsed.
Fails with <code>Netplex_config.Config_error</code> when an error in the
configuration is detected.</p>
      
      <p>The <code>late_initializer</code> is called after the Netplex controller has been
fully initialized, and before the main event loop is entered. You can
perform here further initializations, e.g. starting helper threads.</p>
      
      <p>The <code>config_parser</code> is by default <code>Netplex_config.read_config_file</code>.
You can override it by whatever parser you would like to use. The
parser is only used if a configuration tree is unavailable, and
the configuration needs to be loaded from a file.</p>
      
      <p>As side-effect, the current logger of the [root:Netlog] module is set
to selected Netplex logger. Note that this setting remains active
even after <code>startup</code> returns to the caller. Also note that log messages
submitted via [root:Netlog] appear as from component &quot;netplex.other&quot;
if they are sent from outside of a container.</p>
      
      <p>It is changed to <code>/</code> as working directory (as required for a daemon).</p>
      
        
      </div>
    
  </div>
  
  </div>
  
  <div class="region" id="/val:run">
  <a href="index.html#/val:run" class="anchor">#</a>
  
  <div class="val">
    <span class="keyword">val</span> run : ?config_parser:(string <span class="rarr"><span>-&gt;</span></span> <a href="../../../../ocamlnet.3.7.7/src/netplex/netplex_types/">Netplex_types</a>.<a href="../../../../ocamlnet.3.7.7/src/netplex/netplex_types/#/classtype:config_file">config_file</a>) <span class="rarr"><span>-&gt;</span></span> late_initializer:(<a href="../../../../ocamlnet.3.7.7/src/netplex/netplex_types/">Netplex_types</a>.<a href="../../../../ocamlnet.3.7.7/src/netplex/netplex_types/#/classtype:config_file">config_file</a> <span class="rarr"><span>-&gt;</span></span> <a href="../../../../ocamlnet.3.7.7/src/netplex/netplex_types/">Netplex_types</a>.<a href="../../../../ocamlnet.3.7.7/src/netplex/netplex_types/#/classtype:controller">controller</a> <span class="rarr"><span>-&gt;</span></span> 'a) <span class="rarr"><span>-&gt;</span></span> extract_result:(<a href="../../../../ocamlnet.3.7.7/src/netplex/netplex_types/">Netplex_types</a>.<a href="../../../../ocamlnet.3.7.7/src/netplex/netplex_types/#/classtype:controller">controller</a> <span class="rarr"><span>-&gt;</span></span> 'a <span class="rarr"><span>-&gt;</span></span> 'b) <span class="rarr"><span>-&gt;</span></span> <a href="../../../../ocamlnet.3.7.7/src/netplex/netplex_types/">Netplex_types</a>.<a href="../../../../ocamlnet.3.7.7/src/netplex/netplex_types/#/classtype:parallelizer">parallelizer</a> <span class="rarr"><span>-&gt;</span></span> <a href="../../../../ocamlnet.3.7.7/src/netplex/netplex_types/">Netplex_types</a>.<a href="../../../../ocamlnet.3.7.7/src/netplex/netplex_types/#/classtype:logger_factory">logger_factory</a> list <span class="rarr"><span>-&gt;</span></span> <a href="../../../../ocamlnet.3.7.7/src/netplex/netplex_types/">Netplex_types</a>.<a href="../../../../ocamlnet.3.7.7/src/netplex/netplex_types/#/classtype:workload_manager_factory">workload_manager_factory</a> list <span class="rarr"><span>-&gt;</span></span> <a href="../../../../ocamlnet.3.7.7/src/netplex/netplex_types/">Netplex_types</a>.<a href="../../../../ocamlnet.3.7.7/src/netplex/netplex_types/#/classtype:processor_factory">processor_factory</a> list <span class="rarr"><span>-&gt;</span></span> <a href="index.html#/type:cmdline_config">cmdline_config</a> <span class="rarr"><span>-&gt;</span></span> 'b
    
      <div class="doc">
        
      <p>Similar to <code>startup</code>, but this function is tailored for Netplex
systems that compute results (e.g. Netmulticore jobs). In this
scenario, it is
not sufficient to just fire off child processes, but you also want
to return a result to the caller once the processes have finished
their tasks. One consequence of this is that you cannot daemonize
the program - it always runs in the foreground (no matter whether
<code>-fg</code> is given or not).</p>
      
      <p><code>run</code> expects that the caller passes a function <code>extract_result</code>.
This function is invoked once the Netplex system is done, and
the user can extract the final result from the controller. The
result of <code>extract_result</code> is also the result of <code>run</code>.</p>
      
      <p>At the moment <code>extract_result</code> is invoked, the child processes are
already terminated. They should have put their result at a place
that is in the controller, or can be reached with the help of the
controller. The controller functionality is still fully available.</p>
      
      <p>Note that the controller is shut down as soon as <code>extract_result</code>
returns. Further interactions with the controller are not possible.</p>
      
      <p>The <code>late_initializer</code> is now obligatory for typing reasons
(so you can get the result of the <code>late_initializer</code> from
<code>extract_result</code>). If you don't need it, just return <code>()</code>.</p>
      
      <p>The working directory is left unchanged.</p>
      
        
      </div>
    
  </div>
  
  </div>
  
      <div class="doc">
        <div class="region">
    <h2 class="section level_2">Tutorial</h2>
    </div>
      <p>The typical main program for a <code>Netplex</code> server system looks like:</p>
      <pre><code>      let my_factories = ...
   
      let start() =
       let opts, cmdconf = Netplex_main.args() in
       Arg.parse 
         opts
         (fun s -&gt; raise(Arg.Bad (&quot;Unknown arg: &quot; ^ s))) 
         &quot;usage: protoserver&quot;;
       let par = Netplex_mp.mp() in  (* or Netplex_mt.mt() *)
       Netplex_main.startup
         par
         Netplex_log.logger_factories
         Netplex_workload.workload_manager_factories
         my_factories
         cmdconf
   
      Sys.set_signal Sys.sigpipe Sys.Signal_ignore;
      start()</code></pre>
      <p>This main program enables:</p>
      <ul><li>The standard command-line arguments <code>-conf</code>, <code>-pid</code> and <code>-fg</code> are
understood</li><li>The configuration file is parsed</li><li>The configuration can refer to all loggers and workload managers
coming with Netplex</li><li>The parallelizer is selected: Here, it is multi-processing
(Netplex_mp). One could also select multi-threading (Netplex_mt)</li><li>The processors defined by <code>my_factories</code> are made available
for connection processing</li></ul>
        
      </div>
    </div>
    <div class="outro"><span class="keyword">end</span></div>
    
  </div>
  
  </body>
</html>